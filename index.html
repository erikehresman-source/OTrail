<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Oregon Trail Lite</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js').catch(console.error);
  });
}
</script>

<style>
  :root {
    --bg: #0f172a;
    --panel: #0b1229;
    --text: #e2e8f0;
    --muted: #94a3b8;
    --accent: #38bdf8;
    --green: #86efac;
    --border: #1f2a44;
    --danger: #f87171;
    --gold: #facc15;
    --river: #fbbf24;
    --fort: #60a5fa;
    --mtn: #a3e635;
  }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
         background: radial-gradient(1200px 600px at 20% -10%, #142049 0%, #0a1024 55%, #070d1d 100%); color: var(--text); }
  .wrap { max-width: 980px; margin: 24px auto; padding: 16px; }
  .card { background: rgba(11,18,41,0.92); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); overflow:hidden; }
  .card-hd { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border); gap:12px; }
  .tt { font-weight: 700; font-size: 20px; letter-spacing:.2px; opacity:.9; }
  .pill { padding: 4px 10px; border-radius: 999px; background: #0b132a; border:1px solid var(--border); white-space:nowrap; }
  .card-bd { padding: 16px; }
  .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  .btn { background:#1e293b; color:var(--text); border:1px solid var(--border); padding:8px 12px; border-radius:12px; cursor:pointer; }
  .btn:hover { background:#24324b; }
  .btn:disabled { opacity:.55; cursor:not-allowed; }
  .btn.secondary { background:#0b132a; }
  .btn.outline { background:transparent; }
  select, input[type="text"], input[type="number"]{
    background:#0b132a; color:var(--text); border:1px solid var(--border);
    padding:8px 10px; border-radius:10px; outline:none;
  }
  .stats { display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 12px; }
  .stats2 { display:grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 12px; margin-top:10px; }
  @media (max-width: 720px) { .stats { grid-template-columns: repeat(2, minmax(0, 1fr)); } .stats2 { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
  .stat { display:flex; align-items:center; gap:10px; border:1px solid var(--border); padding:10px; border-radius:14px; background:#0b132a; }
  .stat .lbl { font-size: 12px; color: var(--muted); }
  .stat .val { font-weight:700; }
  .track { position:relative; height:102px; border:1px solid var(--border); border-radius:14px; overflow:hidden; background: linear-gradient(#0b132a, #10183a); }
  .ground { position:absolute; left:0; right:0; bottom:0; height:12px; background:#163a1e; }
  .wagon { position:absolute; top:38px; left:0; display:flex; gap:8px; align-items:center; transition: left 1.1s ease; }
  .wagon .cab { width:44px; height:24px; background:#d1d5db; border:2px solid #64748b; border-radius:6px; }
  .wheel { width:22px; height:22px; background:#cbd5e1; border:2px solid #64748b; border-radius:50%; position:relative; animation: roll 1.2s linear infinite; }
  .wagon.stop .wheel { animation: none; }
  .wheel:before { content:""; position:absolute; inset:9px; background:#64748b; border-radius:50%; }
  @keyframes roll { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .progress-wrap { background:#0b132a; border:1px solid var(--border); border-radius:10px; height:12px; overflow:hidden; }
  .progress { height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--green)); transition: width .3s ease; }
  .party-row { display:grid; grid-template-columns: 1fr 150px auto auto; gap:8px; align-items:center; }
  .healthbar { height:10px; border:1px solid var(--border); border-radius:999px; overflow:hidden; background:#09122a; }
  .healthfill { height:100%; width:100%; transition: width .2s linear; background: linear-gradient(90deg, #2dd4bf, #22c55e); }
  .healthfill.low { background: linear-gradient(90deg, #f43f5e, #fb7185); }
  .log { height:220px; overflow:auto; border:1px solid var(--border); border-radius:12px; padding:8px; background: rgba(3,9,22,0.5); }
  .log .item { display:flex; gap:8px; font-size: 14px; }
  .grave { display:flex; justify-content:space-between; align-items:center; border:1px dashed #334155; padding:8px 10px; border-radius:10px; }
  .grave .rip { color: var(--danger); font-weight:700; }
  /* Map markers */
  .marker { position:absolute; bottom:14px; transform: translateX(-50%); text-align:center; pointer-events:none; }
  .marker .lbl { font-size:10px; color:#e5e7eb; white-space:nowrap; text-shadow:0 1px 0 #000; margin-top:2px; }
  .mk-river .pin { width:8px; height:8px; background:var(--river); border-radius:50%; border:2px solid #92400e; margin:0 auto; }
  .mk-fort .pin { width:10px; height:10px; background:var(--fort); border-radius:3px; border:2px solid #1e3a8a; margin:0 auto; }
  .mk-mtn .pin { width: 0; height: 0; border-left:7px solid transparent; border-right:7px solid transparent; border-bottom:12px solid var(--mtn); margin:0 auto; }
  .mk-done .pin { filter: grayscale(1) brightness(.7); opacity:.8; }

  /* Overlays (shop, river, end screens) */
  .overlay { position:fixed; inset:0; background:rgba(2,6,23,.92); display:none; align-items:center; justify-content:center; padding:16px; z-index:50; }
  .overlay .card { width:min(940px, 100%); background: rgba(11,18,41,0.98); border:1px solid var(--border); border-radius:16px; padding:16px; }
  .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .rowc { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .t1 { font-size: 22px; font-weight: 800; letter-spacing: .3px; }
  .t2 { font-size: 14px; color: var(--muted); }
  .big { font-size: 28px; font-weight: 900; }
  .cele { background: linear-gradient(90deg, var(--gold), #fff); -webkit-background-clip: text; background-clip: text; color: transparent; }

  /* Victory animation */
  .vic-scene { position:relative; height:220px; border:1px solid var(--border); border-radius:12px; overflow:hidden; background: linear-gradient(#1e3a8a, #60a5fa 60%, #14532d 60%, #166534 100%); }
  .vic-town { position:absolute; bottom:60px; right:0; left:0; height:80px; background:
      linear-gradient(#111827 0 0) bottom/100% 5px no-repeat; }
  .vic-town:before { content:""; position:absolute; bottom:5px; left:50%; transform:translateX(-50%);
    width:560px; height:60px;
    background:
      radial-gradient(circle at 40px 40px,#111827 18px,transparent 19px) 0 0/120px 60px repeat-x,
      linear-gradient(#111827 0 0) center/100% 100% no-repeat;
    filter: drop-shadow(0 2px 0 rgba(0,0,0,.6));
  }
  .vic-wagon { position:absolute; bottom:62px; left:-140px; display:flex; gap:8px; align-items:center; animation: arrive 5s ease-out forwards; }
  .vic-wagon .cab { width:54px; height:30px; background:#f1f5f9; border:2px solid #64748b; border-radius:8px; }
  .vic-wheel { width:24px; height:24px; background:#e5e7eb; border:2px solid #64748b; border-radius:50%; position:relative; animation: roll 0.9s linear infinite; }
  .vic-wheel:before { content:""; position:absolute; inset:10px; background:#64748b; border-radius:50%; }
  @keyframes arrive { 0% { left:-140px; } 70% { left:65%; } 85% { left:60%; } 100% { left:62%; } }
  .confetti { position:absolute; inset:0; pointer-events:none; }
  .confetti i { position:absolute; width:6px; height:10px; background:var(--gold); animation: conf 2.2s linear infinite; opacity:.9; }
  .confetti i:nth-child(3n){ background:var(--accent); }
  .confetti i:nth-child(4n){ background:#22c55e; }
  .confetti i:nth-child(5n){ background:#e879f9; }
  @keyframes conf { 0% { transform:translateY(-20px) rotate(0); opacity:1; } 100% { transform:translateY(240px) rotate(360deg); opacity:0; } }
</style>
</head>
<body>
<div class="wrap">
<div class="card">
  <div class="card-hd">
    <div class="tt">Oregon‚ÄëTrail‚ÄëLite ‚Äî Forts, Mountains, Seasons & Snakes</div>
    <div class="pill">Day <span id="day">1</span> ¬∑ <span id="dateLabel">Apr 1</span></div>
  </div>
  <div class="card-bd">
    <!-- Distance & progress -->
    <div class="mt8">
      <div class="row" style="gap:8px; margin-bottom:6px;">
        <span>üë£</span><span id="milesLabel">0 / 900 miles</span>
      </div>
      <div class="progress-wrap"><div class="progress" id="progress"></div></div>
      <div class="track mt8" id="track">
        <div class="wagon" id="wagon">
          <div class="cab"></div>
          <div class="wheel"></div>
          <div class="wheel" style="margin-left:-8px;"></div>
        </div>
        <div class="ground"></div>
        <!-- markers injected here -->
      </div>
    </div>

    <!-- Stats -->
    <div class="stats mt16">
      <div class="stat"><span>ü•™</span><div><div class="lbl">Food (lb)</div><div class="val" id="food">0</div></div></div>
      <div class="stat"><span>‚ù§Ô∏è</span><div><div class="lbl">Party Avg Health</div><div class="val" id="healthAvg">100</div></div></div>
      <div class="stat"><span>üå§Ô∏è</span><div><div class="lbl">Pace</div><div class="val" id="paceVal">steady</div></div></div>
      <div class="stat"><span>‚õ∫</span><div><div class="lbl">Rations</div><div class="val" id="rationsVal">normal</div></div></div>
    </div>
    <div class="stats2">
      <div class="stat"><span>üíµ</span><div><div class="lbl">Money</div><div class="val" id="money">$0</div></div></div>
      <div class="stat"><span>üêÇ</span><div><div class="lbl">Oxen Teams</div><div class="val" id="oxen">0</div></div></div>
      <div class="stat"><span>üß•</span><div><div class="lbl">Clothing Sets</div><div class="val" id="clothing">0</div></div></div>
      <div class="stat"><span>üîß</span><div><div class="lbl">Spare Parts</div><div class="val" id="parts">0</div></div></div>
      <div class="stat"><span>üî´</span><div><div class="lbl">Ammo (rnd)</div><div class="val" id="ammo">0</div></div></div>
    </div>

    <!-- Controls -->
    <div class="row mt12">
      <button class="btn" id="btnTravel">Travel (T)</button>
      <button class="btn secondary" id="btnRest">Rest (R)</button>
      <button class="btn secondary" id="btnHunt">Hunt (H)</button>
      <button class="btn secondary" id="btnForage">Forage (F)</button>
      <button class="btn secondary" id="btnNext">Next Day (N)</button>
      <button class="btn secondary" id="btnBuy">Trade (B)</button>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <label> Pace:<select id="pace"><option>slow</option><option selected>steady</option><option>grueling</option></select></label>
        <label> Rations:<select id="rations"><option>meager</option><option selected>normal</option><option>full</option></select></label>
        <label> Start:<select id="startMonth"><option>March</option><option selected>April</option><option>May</option><option>June</option><option>July</option></select></label>
        <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" id="toggleShortcuts" checked> Shortcuts</label>
        <button class="btn outline" id="btnReset">Reset</button>
      </div>
    </div>

    <!-- Party editor -->
    <div class="mt16">
      <div style="font-weight:700; margin-bottom:6px;">Party</div>
      <div id="partyList"></div>
      <button class="btn mt8" id="btnAdd">+ Add Member</button>
    </div>

    <!-- Graves -->
    <div class="mt16">
      <div style="font-weight:700; margin-bottom:6px;">Graves</div>
      <div id="graves"></div>
    </div>

    <!-- Log -->
    <div class="mt16">
      <div style="font-weight:700; margin-bottom:6px;">Trail Log</div>
      <div class="log" id="log"></div>
    </div>
  </div>
</div>
</div>

<!-- Shop -->
<div class="overlay" id="shop">
  <div class="card">
    <div class="rowc"><div class="t1">Outfitter ‚Äî Buy your supplies</div><div class="pill">Budget: <span id="shopBudget">$0</span></div></div>
    <div class="t2" style="margin:6px 0 10px;">Tip: You‚Äôll need at least <b>1 oxen team</b> and some <b>food</b> to begin. Banker professions add to your starting money.</div>
    <div class="grid2">
      <div class="stat"><span>üêÇ</span><div style="width:100%"><div class="lbl">Oxen team (2 oxen)</div><div class="rowc"><input class="num" type="number" min="0" id="siOxen" value="1"><span class="t2">$40 each</span></div></div></div>
      <div class="stat"><span>ü•™</span><div style="width:100%"><div class="lbl">Food (pounds)</div><div class="rowc"><input class="num" type="number" min="0" id="siFood" value="200"><span class="t2">$0.20 / lb</span></div></div></div>
      <div class="stat"><span>üß•</span><div style="width:100%"><div class="lbl">Clothing sets</div><div class="rowc"><input class="num" type="number" min="0" id="siClothing" value="4"><span class="t2">$10 each</span></div></div></div>
      <div class="stat"><span>üî´</span><div style="width:100%"><div class="lbl">Ammo (20/box)</div><div class="rowc"><input class="num" type="number" min="0" id="siAmmoBoxes" value="6"><span class="t2">$2 / box</span></div></div></div>
      <div class="stat"><span>üîß</span><div style="width:100%"><div class="lbl">Spare parts kits</div><div class="rowc"><input class="num" type="number" min="0" id="siParts" value="2"><span class="t2">$15 each</span></div></div></div>
    </div>
    <div class="rowc" style="margin-top:10px;">
      <div>Remaining: <span id="shopRemaining">$0</span></div>
      <div style="display:flex; gap:8px;">
        <button class="btn outline" id="shopCancel">Cancel</button>
        <button class="btn" id="shopBegin">Begin Journey</button>
      </div>
    </div>
  </div>
</div>

<!-- River crossing -->
<div class="overlay" id="river">
  <div class="card">
    <div class="t1">River Crossing</div>
    <div class="t2" id="riverInfo" style="margin:6px 0 10px;"></div>
    <div class="grid2">
      <div class="stat" style="align-items:flex-start;"><div><div class="lbl">Ford the river</div><div class="t2">Fast & free, but risky at deeper rivers.</div></div><div><button class="btn" id="rvFord">Ford</button></div></div>
      <div class="stat" style="align-items:flex-start;"><div><div class="lbl">Caulk & float</div><div class="t2">Seal the wagon; safer than fording. Costs time.</div></div><div><button class="btn" id="rvFloat">Caulk</button></div></div>
      <div class="stat" style="align-items:flex-start;"><div><div class="lbl">Hire a ferry</div><div class="t2">Safest, but costs money and time.</div></div><div><button class="btn" id="rvFerry">Ferry</button></div></div>
      <div class="stat" style="align-items:flex-start;"><div><div class="lbl">Wait a day</div><div class="t2">Sometimes the water lowers.</div></div><div><button class="btn outline" id="rvWait">Wait</button></div></div>
    </div>
  </div>
</div>

<!-- Victory -->
<div class="overlay" id="victory">
  <div class="card" style="text-align:center;">
    <div class="big cele">You made it!</div>
    <div class="vic-scene">
      <div class="vic-town"></div>
      <div class="vic-wagon">
        <div class="cab"></div>
        <div class="vic-wheel"></div>
        <div class="vic-wheel" style="margin-left:-8px;"></div>
      </div>
      <div class="confetti" id="confetti"></div>
    </div>
    <div class="t2" id="vicStats" style="margin:8px 0 12px;"></div>
    <button class="btn" id="vicReset">Play Again</button>
  </div>
</div>

<!-- Defeat -->
<div class="overlay" id="defeat">
  <div class="card" style="text-align:center;">
    <div class="big" style="color:var(--danger);">All parties have died.</div>
    <div class="t2" style="margin:8px 0 12px;">Try again?</div>
    <button class="btn" id="defReset">Play Again</button>
  </div>
</div>

<script>
(function(){
  'use strict';
  // Safe storage fallback
  const storage = (()=>{
    try { const t='ot_test_'+Date.now(); localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; }
    catch(e){ const mem={}; return {getItem:k=>mem[k]||null,setItem:(k,v)=>{mem[k]=String(v)},removeItem:k=>{delete mem[k]}}; }
  })();

  const DESTINATION_MILES = 900;
  const START = { food:0, money:300, miles:0, day:1 }; // baseline $300
  const MAX_PARTY = 6;
  const PROFESSIONS = ["None","Banker","Carpenter","Farmer","Hunter","Doctor"];
  const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const MONTH_DAYS = [31,28,31,30,31,30,31,31,30,31,30,31];

  // Rivers
  const RIVERS = [
    { name: 'Kansas River', mile: 102, width: 630, depth: 2.5, ferry: 5 },
    { name: 'Big Blue River', mile: 185, width: 200, depth: 3.5, ferry: 3 },
    { name: 'Green River', mile: 600, width: 400, depth: 4.5, ferry: 8 },
    { name: 'Snake River', mile: 800, width: 1000, depth: 6.0, ferry: 12 }
  ];
  // Forts & mountains (approximate mileposts on our 0..900 scale)
  const LANDMARKS = [
    { type:'fort', name:'Fort Kearny', mile:240 },
    { type:'mtn',  name:'Chimney Rock', mile:300 },
    { type:'fort', name:'Fort Laramie', mile:420 },
    { type:'mtn',  name:'Independence Rock', mile:520 },
    { type:'mtn',  name:'South Pass', mile:650 },
    { type:'fort', name:'Fort Hall', mile:730 },
    { type:'mtn',  name:'Blue Mountains', mile:820 },
    { type:'fort', name:'The Dalles', mile:880 }
  ];

  let crossed = RIVERS.map(()=>false);
  let currentRiver = -1;

  // Date state
  let curMonthIdx = 3; // April
  let curDayOfMonth = 1;

  // Profession bonuses
  function computeBonuses(party){
    const counts = { Banker:0, Carpenter:0, Farmer:0, Hunter:0, Doctor:0 };
    party.forEach(m=>{ if (m.alive && counts.hasOwnProperty(m.prof)) counts[m.prof]++; });
    return {
      bankerMoneyBonus: 50 * counts.Banker,
      forageMultiplier: 1 + 0.30 * counts.Farmer,
      huntMultiplier: 1 + 0.30 * counts.Hunter,
      restHealBonus: 2 * counts.Doctor,
      breakdownLossFactor: Math.max(0.2, Math.pow(0.5, counts.Carpenter)) // min 20%
    };
  }

  function loadPartyV3(){
    const raw = storage.getItem('trail.party.v3');
    if (raw) { try { return JSON.parse(raw); } catch(e){} }
    let names = ["Alex","Bailey","Casey","Dakota"];
    const rawV2 = storage.getItem('trail.party.v2');
    if (rawV2) { try { const v2 = JSON.parse(rawV2); names = v2.map(p=>p.name); } catch(e){} }
    const rawV1 = storage.getItem('trail.party');
    if (rawV1 && !rawV2) { try { names = JSON.parse(rawV1); } catch(e){} }
    return names.slice(0,4).map(n=>({ name:n, prof:"None", health:100, alive:true }));
  }

  let party = loadPartyV3();
  let graves = []; // {name, day, reason, prof}

  // Core state
  let food = START.food, money = START.money, miles = START.miles, day = START.day;
  let pace = 'steady', rations = 'normal';
  let oxenTeams = 0, clothingSets = 0, ammo = 0, spareParts = 0;
  let shortcutsEnabled = true;
  let modalOpen = false;

  function startingBudget(){ return START.money + computeBonuses(party).bankerMoneyBonus; }

  // DOM refs
  const el = id => document.getElementById(id);
  const elDay = el('day'), elFood = el('food'), elHealthAvg = el('healthAvg');
  const elMilesLabel = el('milesLabel'), elProgress = el('progress'), elWagon = el('wagon'), track = el('track');
  const elPaceVal = el('paceVal'), elRationsVal = el('rationsVal');
  const selPace = el('pace'), selRations = el('rations'), selStartMonth = el('startMonth');
  const logBox = el('log'), partyList = el('partyList'), gravesBox = el('graves');
  const elMoney = el('money'), elOxen = el('oxen'), elClothing = el('clothing'), elAmmo = el('ammo'), elParts = el('parts');
  const chkShortcuts = el('toggleShortcuts');
  const elDateLabel = el('dateLabel');

  // Overlays
  const shop = el('shop'), river = el('river'), victory = el('victory'), defeat = el('defeat');
  const riverInfo = el('riverInfo'); const rvFord = el('rvFord'), rvFloat = el('rvFloat'), rvFerry = el('rvFerry'), rvWait = el('rvWait');
  const vicStats = el('vicStats'), vicReset = el('vicReset'); const defReset = el('defReset'); const confetti = el('confetti');

  // Shop refs
  const siOxen = el('siOxen'), siFood = el('siFood'), siClothing = el('siClothing'), siAmmoBoxes = el('siAmmoBoxes'), siParts = el('siParts');
  const shopBudget = el('shopBudget'), shopRemaining = el('shopRemaining');
  const btnBegin = el('shopBegin'), btnCancel = el('shopCancel');

  // Utils
  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
  const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const pickIdx = (arr, pred=(x)=>x)=>{
    const idxs = arr.map((v,i)=>({v,i})).filter(o=>pred(o.v)).map(o=>o.i);
    return idxs.length? idxs[rand(0,idxs.length-1)] : -1;
  };
  const liveMembers = ()=>party.filter(p=>p.alive);
  const everyoneDead = ()=>liveMembers().length === 0;
  const avgHealth = ()=>{
    const live = liveMembers();
    if (!live.length) return 0;
    return Math.round(live.reduce((s,p)=>s+p.health,0) / live.length);
  };
  const isTypingTarget = (t)=> t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.tagName === 'SELECT' || t.isContentEditable);

  function fmtDate(){ return MONTHS[curMonthIdx] + ' ' + curDayOfMonth; }

  function pushLog(txt){
    const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = '<span>‚öë</span><span>'+ time +' ‚Äî '+ txt +'</span>';
    logBox.prepend(div);
    while (logBox.children.length > 200) logBox.removeChild(logBox.lastChild);
  }

  function saveParty(){ storage.setItem('trail.party.v3', JSON.stringify(party)); }

  function killMember(member, reason){
    if (!member.alive) return;
    member.alive = false; member.health = 0;
    graves.push({ name: member.name, day, reason, prof: member.prof });
    pushLog('üíÄ ' + member.name + ' ('+member.prof+') has died ‚Äî ' + reason + '.');
    saveParty();
  }

  function renderParty(){
    partyList.innerHTML = '';
    party.forEach((m, i) => {
      const row = document.createElement('div');
      row.className = 'party-row mt8';
      const healthPct = clamp(m.health,0,100);
      const dead = !m.alive;
      const profOptions = PROFESSIONS.map(p=>`<option ${m.prof===p?'selected':''}>${p}</option>`).join('');
      row.innerHTML =
        `<input type="text" value="${m.name.replace(/"/g,'&quot;')}" ${dead?'disabled':''} style="max-width:260px;">` +
        `<select ${dead?'disabled':''} title="Profession">${profOptions}</select>` +
        `<div class="healthbar" title="Health: ${healthPct}%"><div class="healthfill ${healthPct<=30?'low':''}" style="width:${healthPct}%"></div></div>` +
        `<div style="display:flex; gap:6px; align-items:center;">` +
          (dead? '<span title="Deceased">üíÄ</span>' : '') +
          `<button class="btn outline" title="Remove">üóëÔ∏è</button>` +
        `</div>`;
      const input = row.querySelector('input');
      const select = row.querySelector('select');
      const btnDel = row.querySelector('button');
      input && input.addEventListener('input', ()=>{ m.name = input.value; saveParty(); });
      select && select.addEventListener('change', ()=>{ m.prof = select.value; saveParty(); });
      btnDel.addEventListener('click', ()=>{ party.splice(i,1); saveParty(); uiUpdate(); });
      partyList.appendChild(row);
    });
    el('btnAdd').disabled = party.length >= MAX_PARTY;
  }

  function renderGraves(){
    gravesBox.innerHTML = '';
    graves.forEach(g=>{
      const row = document.createElement('div');
      row.className = 'grave mt8';
      row.innerHTML = `<span class="rip">üíÄ ${g.name} (${g.prof})</span><span>Day ${g.day} ‚Äî ${g.reason}</span>`;
      gravesBox.appendChild(row);
    });
  }

  function renderMarkers(){
    track.querySelectorAll('.marker').forEach(m=>m.remove());
    const trackWidth = track.clientWidth - 12;
    function addMarker(x, name, cls, done){
      const mk = document.createElement('div');
      mk.className = `marker ${cls} ${done?'mk-done':''}`;
      mk.style.left = x + 'px';
      mk.innerHTML = `<div class="pin"></div><div class="lbl">${name}</div>`;
      track.appendChild(mk);
    }
    // Rivers
    RIVERS.forEach((r,i)=>{
      const x = Math.max(10, Math.min(trackWidth-10, (r.mile/DESTINATION_MILES) * trackWidth));
      addMarker(x, r.name, 'mk-river', crossed[i]);
    });
    // Landmarks
    LANDMARKS.forEach(l=>{
      const x = Math.max(10, Math.min(trackWidth-10, (l.mile/DESTINATION_MILES) * trackWidth));
      addMarker(x, l.name, l.type==='fort'?'mk-fort':'mk-mtn', miles >= l.mile);
    });
  }

  function uiUpdate(){
    elDay.textContent = day;
    elDateLabel.textContent = fmtDate();
    elFood.textContent = food;
    elHealthAvg.textContent = avgHealth();
    elMilesLabel.textContent = miles + ' / ' + DESTINATION_MILES + ' miles';
    elProgress.style.width = (miles/DESTINATION_MILES*100)+'%';
    elPaceVal.textContent = pace;
    elRationsVal.textContent = rations;
    elMoney.textContent = '$' + money.toFixed(2);
    elOxen.textContent = oxenTeams;
    elClothing.textContent = clothingSets;
    elAmmo.textContent = ammo;
    elParts.textContent = spareParts;
    const trackWidth = elWagon.parentElement.clientWidth - 100;
    elWagon.style.left = Math.min(trackWidth, Math.max(0, (miles/DESTINATION_MILES) * trackWidth)) + 'px';
    renderParty(); renderGraves(); renderMarkers();
  }

  function baseFoodUse(){ return {meager:3, normal:5, full:7}[rations] * liveMembers().length; }
  function baseMiles(){
    const paceMiles = {slow:12, steady:18, grueling:24}[pace];
    const oxenMult = 1 + 0.15 * Math.max(0, oxenTeams-1);
    return Math.round(paceMiles * oxenMult);
  }
  function baseHealthDelta(){
    const r = ({meager:-2, normal:0, full:+1}[rations]);
    const p = ({slow:+1, steady:0, grueling:-2}[pace]);
    const missingClothes = Math.max(0, liveMembers().length - clothingSets);
    const clothingPenalty = missingClothes>0 ? -1 : 0;
    return r + p + clothingPenalty;
  }

  function applyGroupHealth(delta){
    liveMembers().forEach(p=>{
      p.health = clamp(p.health + delta, 0, 100);
      if (p.health <= 0) killMember(p, 'succumbed to hardship');
    });
  }

  // Date helpers
  function advanceDays(n){
    for (let i=0;i<n;i++){
      day += 1;
      curDayOfMonth += 1;
      if (curDayOfMonth > MONTH_DAYS[curMonthIdx]){
        curDayOfMonth = 1;
        curMonthIdx = (curMonthIdx + 1) % 12;
      }
    }
  }

  function seasonWeatherChance(){
    // base chance by month (approx ‚Äî later months worse)
    const table = [0.10,0.10,0.12,0.12,0.14,0.12,0.10,0.12,0.18,0.26,0.34,0.40];
    return table[curMonthIdx] || 0.12;
  }

  function pickWeatherEvent(){
    // choose heat/cold/storm with seasonal tilt
    let t = Math.random();
    if (curMonthIdx <= 3) { // Jan-Apr: more cold
      if (t < 0.55) return 'cold';
      if (t < 0.8) return 'storm';
      return 'heat';
    } else if (curMonthIdx <= 7) { // May-Aug: more heat/storm
      if (t < 0.5) return 'heat';
      if (t < 0.85) return 'storm';
      return 'cold';
    } else { // Sep-Dec: more cold/storm
      if (t < 0.55) return 'cold';
      if (t < 0.9) return 'storm';
      return 'heat';
    }
  }

  // Event engine
  function weatherEvent(){
    const type = pickWeatherEvent();
    if (type === 'heat'){
      const dmg = rand(2,5) + (rations==='meager'?1:0);
      applyGroupHealth(-dmg);
      pushLog('A heat wave saps everyone\'s strength.');
      return { food:-rand(4,10), miles:-rand(0,6), money:0, type:'heat' };
    }
    if (type === 'cold'){
      const underdressed = Math.max(0, liveMembers().length - clothingSets)>0;
      const dmg = rand(2,6) + (underdressed?2:0);
      applyGroupHealth(-dmg);
      pushLog('A cold snap chills the camp.' + (underdressed?' Some are underdressed.':''));
      return { food:-rand(4,10), miles:-rand(0,6), money:0, type:'cold' };
    }
    // storm
    const dmg = rand(2,6) + (Math.max(0, liveMembers().length - clothingSets)>0 ? 1 : 0);
    applyGroupHealth(-dmg);
    pushLog('A storm slows your progress.');
    return { food:-rand(5,12), miles:-rand(5,20), money:0, type:'storm' };
  }

  function nonWeatherEvent(context){
    const idx = pickIdx(party, p=>p.alive);
    const who = idx>=0 ? party[idx] : null;
    const r = Math.random();
    // context-weighted ordering
    if (r < 0.16) { // rattlesnake encounter (distinct)
      if (who){
        const dmg = rand(10,22);
        who.health = clamp(who.health - dmg, 0, 100);
        pushLog(`${who.name} (${who.prof}) is struck by a rattlesnake (-${dmg} health).`);
        if (who.health<=0) killMember(who, 'rattlesnake bite');
      }
      return { food:0, miles:-rand(2,8), money:0, type:'rattlesnake' };
    }
    if (r < 0.28 && context!=='rest') { // wagon stuck
      const baseLoss = rand(8,20);
      const milesLoss = Math.round(baseLoss * 0.9);
      pushLog('The wagon gets stuck in the mud; you dig it out.');
      return { food:-rand(2,6), miles:-milesLoss, money:0, type:'stuck' };
    }
    if (r < 0.40) { // breakdown
      const dmg = rand(1,4);
      applyGroupHealth(-dmg);
      if (spareParts > 0) {
        spareParts--; pushLog('A wagon wheel breaks, but a spare part fixes it quickly.');
        return { food:-rand(2,5), miles:0, money:0, type:'breakdown' };
      }
      pushLog('A wagon wheel breaks and you make repairs.');
      return { food:-rand(4,10), miles:-rand(10,25), money:-rand(5,15), type:'breakdown' };
    }
    if (r < 0.54) { // find food/water
      const heal = rand(1,4);
      applyGroupHealth(+heal);
      if (who) pushLog(`${who.name} (${who.prof}) finds wild berries and a stream (+${heal} health).`);
      return { food:+rand(8,24), miles:0, money:0, type:'find' };
    }
    if (r < 0.70) { // friendly traders
      const foodGain = rand(12,28);
      const cost = Math.max(1, Math.round(foodGain * 0.1));
      if (money >= cost) { money -= cost; pushLog(`Friendly traders offer supplies. You buy ${foodGain} lb of food for $${cost}.`); return { food:+foodGain, miles:0, money:0, type:'friendly' }; }
      else { pushLog('Friendly traders stop by, but you lack money to trade.'); return { type:'friendly' }; }
    }
    if (r < 0.86) { // raiders
      let lossFood = rand(10,40), lossAmmo = rand(0,15);
      if (ammo >= 5){ const used = 5; ammo -= used; lossFood = Math.max(0, lossFood - rand(8,18));
        pushLog(`Raiders ambush the camp, but you drive them off (used ${used} ammo).`);
      } else {
        pushLog('Raiders steal supplies during the night!');
      }
      return { food:-lossFood, miles:0, money:0, type:'hostile', ammo:-lossAmmo };
    }
    // illness last
    if (who){
      const dmg = rand(6,14);
      who.health = clamp(who.health - dmg, 0, 100);
      pushLog(`${who.name} (${who.prof}) falls ill (-${dmg} health).`);
      if (who.health<=0) killMember(who, 'illness');
    }
    return { type:'illness' };
  }

  function triggerEvent(context, baseProb){
    // First, seasonal weather roll (independent small chance)
    const weatherProb = seasonWeatherChance();
    let happened = false;
    if (Math.random() < weatherProb){
      let evt = weatherEvent();
      evt = applyProfessionEffectsToEvent(evt);
      applyEventDeltas(evt);
      happened = true;
    }
    // Then a general event roll (higher than before)
    if (Math.random() < baseProb){
      let evt = nonWeatherEvent(context);
      evt = applyProfessionEffectsToEvent(evt);
      applyEventDeltas(evt);
      happened = true;
    }
    if (happened) uiUpdate();
  }

  function applyProfessionEffectsToEvent(evt){
    if (!evt) return evt;
    const bonuses = computeBonuses(party);
    const out = { ...evt };
    if (evt.type === 'breakdown' && out.miles < 0){
      out.miles = Math.round(out.miles * bonuses.breakdownLossFactor);
    }
    if (evt.type === 'find' && out.food > 0){
      out.food = Math.round(out.food * bonuses.forageMultiplier);
    }
    return out;
  }

  function applyEventDeltas(evt){
    if (!evt) return;
    if (typeof evt.food === 'number') food = clamp(food + evt.food, 0, 99999);
    if (typeof evt.miles === 'number') miles = clamp(miles + evt.miles, 0, DESTINATION_MILES);
    if (typeof evt.money === 'number') money = clamp(money + evt.money, 0, 99999);
    if (typeof evt.ammo === 'number') ammo = clamp(ammo + evt.ammo, 0, 99999);
    checkEnd();
  }

  // Rivers
  function checkForRiver(prevMiles, newMiles){
    for (let i=0;i<RIVERS.length;i++){
      if (crossed[i]) continue;
      const r = RIVERS[i];
      if (prevMiles < r.mile && newMiles >= r.mile){
        miles = r.mile;
        openRiver(i);
        pushLog(`You reach the ${r.name}.`);
        uiUpdate();
        return true;
      }
    }
    return false;
  }

  function openRiver(i){
    currentRiver = i;
    const r = RIVERS[i];
    riverInfo.textContent = `${r.name} ‚Äî width ~${r.width} ft, depth ~${r.depth.toFixed(1)} ft. Ferry costs $${r.ferry}.`;
    river.style.display = 'flex'; modalOpen = true;
  }
  function closeRiver(){ river.style.display = 'none'; modalOpen = false; }

  function riverRisk(depth){
    if (depth < 2) return 0.08;
    if (depth < 3.5) return 0.18;
    if (depth < 5) return 0.32;
    return 0.45;
  }
  function riverOutcome(kind){
    const r = RIVERS[currentRiver];
    let chanceFail = 0, timeDays = 1, moneyCost = 0;
    if (kind==='ford'){ chanceFail = riverRisk(r.depth); timeDays = 0; }
    else if (kind==='float'){ chanceFail = Math.max(0.08, riverRisk(r.depth) * 0.5); timeDays = 1; }
    else if (kind==='ferry'){ chanceFail = 0.04; timeDays = 1; moneyCost = r.ferry; }
    else if (kind==='wait'){ r.depth = Math.max(1.5, r.depth - 0.5); advanceDays(1); pushLog('You wait a day for better conditions.'); uiUpdate(); return; }
    if (moneyCost > 0){ if (money < moneyCost){ pushLog('Not enough money for the ferry.'); return; } money -= moneyCost; }
    advanceDays(timeDays);
    if (Math.random() < chanceFail){
      const loseFood = rand(20, 80), loseAmmo = rand(10, 40);
      const oxLoss = (Math.random()<0.25 && oxenTeams>0) ? 1 : 0;
      food = clamp(food - loseFood, 0, 99999);
      ammo = clamp(ammo - loseAmmo, 0, 99999);
      oxenTeams = clamp(oxenTeams - oxLoss, 0, 99);
      applyGroupHealth(-rand(6,16));
      pushLog(`Disaster at the ${r.name}! Lost ${loseFood} lb food, ${loseAmmo} ammo${oxLoss?`, ${oxLoss} oxen team`:''}.`);
    } else {
      pushLog(`You cross the ${r.name} safely by ${kind==='ford'?'fording':kind==='float'?'caulking and floating':'ferry'}.`);
      crossed[currentRiver] = true;
      closeRiver();
    }
    uiUpdate(); checkEnd();
  }

  // End screens
  function openVictory(){
    const survivors = liveMembers().length;
    vicStats.textContent = `Date: ${fmtDate()} ¬∑ Days: ${day} ¬∑ Survivors: ${survivors}/${party.length} ¬∑ Food: ${food} lb ¬∑ Money: $${money.toFixed(2)}`;
    confetti.innerHTML = Array.from({length:60}).map(()=>'<i style="left:'+Math.random()*100+'%; animation-delay:'+ (Math.random()*1.2).toFixed(2)+'s"></i>').join('');
    victory.style.display = 'flex'; modalOpen = true;
  }
  function closeVictory(){ victory.style.display = 'none'; modalOpen = false; confetti.innerHTML = ''; }
  function openDefeat(){ defeat.style.display = 'flex'; modalOpen = true; }
  function closeDefeat(){ defeat.style.display = 'none'; modalOpen = false; }

  function checkEnd(){
    const reached = miles >= DESTINATION_MILES;
    const allDead = everyoneDead();
    if (reached){ openVictory(); return; }
    if (allDead){ openDefeat(); return; }
  }

  // Actions
  function doTravel(){
    if (modalOpen) return;
    if (oxenTeams <= 0) { pushLog('You have no oxen to pull the wagon.'); return; }
    const prev = miles;
    const todayMiles = clamp(baseMiles() + rand(-4,6), 4, 36);
    const todayFood = -Math.ceil(baseFoodUse()/2);
    const todayHealth = baseHealthDelta() + rand(-1,1);
    miles = clamp(miles + todayMiles, 0, DESTINATION_MILES);
    food = clamp(food + todayFood, 0, 99999);
    applyGroupHealth(todayHealth);
    advanceDays(1);
    pushLog('You travel ' + todayMiles + ' miles.');
    triggerEvent('travel', 0.6); // higher event rate while traveling
    if (!checkForRiver(prev, miles)) { uiUpdate(); checkEnd(); }
  }

  function doRest(){
    if (modalOpen) return;
    const baseHeal = rand(6,12);
    const heal = baseHeal + computeBonuses(party).restHealBonus;
    liveMembers().forEach(p=>{ p.health = clamp(p.health + heal, 0, 100); });
    food = clamp(food - Math.max(0, liveMembers().length - 1), 0, 99999);
    advanceDays(1);
    pushLog('You rest and recover ~' + heal + ' health per traveler.');
    triggerEvent('rest', 0.3);
    uiUpdate(); checkEnd();
  }

  function doHunt(){
    if (modalOpen) return;
    if (ammo <= 0){ pushLog('No ammunition left to hunt.'); return; }
    const bullets = Math.min(5, ammo);
    ammo -= bullets;
    const mult = computeBonuses(party).huntMultiplier;
    const baseGain = rand(12,34);
    const gain = Math.round(baseGain * mult * (bullets/5));
    food = clamp(food + gain - 2, 0, 99999);
    const idx = pickIdx(party, p=>p.alive);
    if (idx>=0) party[idx].health = clamp(party[idx].health - rand(0,3), 0, 100);
    advanceDays(1);
    pushLog((idx>=0? party[idx].name : 'Someone') + ` hunts and brings back ${gain} lb of food (used ${bullets} ammo).`);
    triggerEvent('hunt', 0.45);
    uiUpdate(); checkEnd();
  }

  function doForage(){
    if (modalOpen) return;
    const mult = computeBonuses(party).forageMultiplier;
    const gain = Math.round(rand(5,14) * mult);
    food = clamp(food + gain - 1, 0, 99999);
    advanceDays(1);
    pushLog('The party forages and finds ' + gain + ' lb of food.');
    triggerEvent('forage', 0.45);
    uiUpdate(); checkEnd();
  }

  function doNextDay(){
    if (modalOpen) return;
    let foodDelta = -Math.ceil(baseFoodUse()/2) - rand(0,2);
    let healthDelta = baseHealthDelta() + rand(-1,1);
    let milesDelta = rand(-1,1);
    food = clamp(food + foodDelta, 0, 99999);
    applyGroupHealth(healthDelta);
    miles = clamp(miles + Math.max(0, milesDelta), 0, DESTINATION_MILES);
    advanceDays(1);
    pushLog('The trail continues.');
    triggerEvent('camp', 0.5);
    uiUpdate(); checkEnd();
  }

  function doBuy(){
    if (modalOpen) return;
    const spend = Math.min(money, rand(3,12));
    if (spend <= 0){ pushLog('You have no money to trade.'); return; }
    money -= spend;
    const randomGoods = rand(1,3);
    if (randomGoods === 1) { food = clamp(food + spend*5, 0, 99999); pushLog('You buy food for $' + spend + '.'); }
    if (randomGoods === 2) { ammo = clamp(ammo + spend*4, 0, 99999); pushLog('You buy ammunition for $' + spend + '.'); }
    if (randomGoods === 3) { spareParts = clamp(spareParts + 1, 0, 99999); pushLog('You buy a spare part for $' + spend + '.'); }
    uiUpdate();
  }

  function resetGame(){
    party = party.map(p=>({ name:p.name, prof:p.prof||"None", health:100, alive:true }));
    graves = [];
    food = 0; miles = 0; day = 1;
    pace = 'steady'; rations = 'normal';
    oxenTeams = 0; clothingSets = 0; ammo = 0; spareParts = 0;
    crossed = RIVERS.map(()=>false); currentRiver = -1;
    // start month from control
    const startOpt = selStartMonth.value; // March..July
    curMonthIdx = {March:2, April:3, May:4, June:5, July:6}[startOpt] || 3;
    curDayOfMonth = 1;
    shortcutsEnabled = true; modalOpen = false;
    money = startingBudget();
    openShop();
    uiUpdate();
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if (!shortcutsEnabled || modalOpen) return;
    if (isTypingTarget(e.target)) return;
    const k = e.key.toLowerCase();
    if (k==='t') { e.preventDefault(); doTravel(); }
    if (k==='r') { e.preventDefault(); doRest(); }
    if (k==='h') { e.preventDefault(); doHunt(); }
    if (k==='f') { e.preventDefault(); doForage(); }
    if (k==='n') { e.preventDefault(); doNextDay(); }
    if (k==='b') { e.preventDefault(); doBuy(); }
  });
  chkShortcuts.addEventListener('change', ()=>{ shortcutsEnabled = chkShortcuts.checked; });

  // Wire controls
  function wire(){
    document.getElementById('btnTravel').onclick = doTravel;
    document.getElementById('btnRest').onclick = doRest;
    document.getElementById('btnHunt').onclick = doHunt;
    document.getElementById('btnForage').onclick = doForage;
    document.getElementById('btnNext').onclick = doNextDay;
    document.getElementById('btnBuy').onclick = doBuy;
    document.getElementById('btnReset').onclick = resetGame;
    document.getElementById('btnAdd').onclick = function(){
      if (party.length >= MAX_PARTY) return;
      party.push({ name:'New Traveler', prof:'None', health:100, alive:true });
      saveParty(); uiUpdate();
    };
    selPace.onchange = (e)=>{ pace = e.target.value; uiUpdate(); };
    selRations.onchange = (e)=>{ rations = e.target.value; uiUpdate(); };
  }

  // Shop logic
  function updateShopBudget(){
    const budget = startingBudget();
    const cost = siOxen.valueAsNumber * 40
               + siFood.valueAsNumber * 0.20
               + siClothing.valueAsNumber * 10
               + siAmmoBoxes.valueAsNumber * 2
               + siParts.valueAsNumber * 15;
    const remaining = clamp((budget - cost), -99999, 99999);
    shopBudget.textContent = '$' + budget.toFixed(2);
    shopRemaining.textContent = '$' + remaining.toFixed(2);
    document.getElementById('shopBegin').disabled = remaining < 0 || siOxen.valueAsNumber < 1 || siFood.valueAsNumber < 1 || party.length < 1;
  }
  [siOxen, siFood, siClothing, siAmmoBoxes, siParts].forEach(inp=>{ inp.addEventListener('input', updateShopBudget); });

  function openShop(){
    siOxen.value = 1; siFood.value = 200; siClothing.value = String(Math.max(4, party.length)); siAmmoBoxes.value = 6; siParts.value = 2;
    updateShopBudget();
    shop.style.display = 'flex'; modalOpen = true;
  }
  btnCancel.addEventListener('click', ()=>{ openShop(); });
  btnBegin.addEventListener('click', ()=>{
    const budget = startingBudget();
    const spent = (siOxen.valueAsNumber * 40 + siFood.valueAsNumber * 0.20 + siClothing.valueAsNumber * 10 + siAmmoBoxes.valueAsNumber * 2 + siParts.valueAsNumber * 15);
    money = budget - spent;
    oxenTeams = siOxen.valueAsNumber;
    food = siFood.valueAsNumber;
    clothingSets = siClothing.valueAsNumber;
    ammo = siAmmoBoxes.valueAsNumber * 20;
    spareParts = siParts.valueAsNumber;
    shop.style.display = 'none'; modalOpen = false;
    pushLog('Your party sets out at dawn. ('+fmtDate()+')');
    uiUpdate();
  });

  // River UI
  rvFord.addEventListener('click', ()=>riverOutcome('ford'));
  rvFloat.addEventListener('click', ()=>riverOutcome('float'));
  rvFerry.addEventListener('click', ()=>riverOutcome('ferry'));
  rvWait.addEventListener('click', ()=>riverOutcome('wait'));

  // End screens buttons
  vicReset.addEventListener('click', resetGame);
  defReset.addEventListener('click', resetGame);

  // Init
  wire();
  resetGame(); // opens shop
})();
</script>
</body>
</html>
